name: keep_serv00

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 * * *'  # 每天北京时间 00:00（UTC+8）

jobs:
  keep_serv00:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        server: [1, 2, 3, 4]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set common secrets
        run: |
          echo "SERVER_HOSTNAME=${{ secrets.SERVER_HOSTNAME }}" >> $GITHUB_ENV
          echo "SERVER_PASSWORD=${{ secrets.SERVER_PASSWORD }}" >> $GITHUB_ENV
          echo "PASSWORD=${{ secrets.PASSWORD }}" >> $GITHUB_ENV

      - name: Set server-specific secrets and alias
        run: |
          case "${{ matrix.server }}" in
            1)
              echo "SERVER_USERNAME=${{ secrets.SERVER_USERNAME_1 }}" >> $GITHUB_ENV
              echo "SERVER_ALIAS=节点1" >> $GITHUB_ENV
              ;;
            2)
              echo "SERVER_USERNAME=${{ secrets.SERVER_USERNAME_2 }}" >> $GITHUB_ENV
              echo "SERVER_ALIAS=节点2" >> $GITHUB_ENV
              ;;
            3)
              echo "SERVER_USERNAME=${{ secrets.SERVER_USERNAME_3 }}" >> $GITHUB_ENV
              echo "SERVER_ALIAS=节点3" >> $GITHUB_ENV
              ;;
            4)
              echo "SERVER_USERNAME=${{ secrets.SERVER_USERNAME_4 }}" >> $GITHUB_ENV
              echo "SERVER_ALIAS=节点4" >> $GITHUB_ENV
              ;;
          esac

      - name: Install sshpass
        run: sudo apt-get install -y sshpass || echo "sshpass already installed"

      - name: SSH into server and run script
        run: |

          sshpass -p "${{ env.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no -T ${{ env.SERVER_USERNAME }}@${{ env.SERVER_HOSTNAME }} -o ConnectTimeout=10 2>/tmp/ssh_error.log || {
            echo -e "\033[31m❌ SSH连接失败: ${{ env.SERVER_ALIAS }}\033[0m"
            echo -e "\033[31m错误信息:\033[0m"
            cat /tmp/ssh_error.log
            exit 1
          }

          sshpass -p "${{ env.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no -T ${{ env.SERVER_USERNAME }}@${{ env.SERVER_HOSTNAME }} << 'EOF'
            set -e
            curl -Ls https://raw.githubusercontent.com/co2f2e/Serv00/main/bash/keep_serv00.sh -o keep_serv00.sh || { echo "❌ 脚本下载失败: $SERVER_ALIAS"; exit 1; }
            bash keep_serv00.sh "$PASSWORD" || { echo "❌ 脚本执行失败: $SERVER_ALIAS"; exit 1; }
            echo -e "\n✅ 脚本执行成功: $SERVER_ALIAS\n"
          EOF
        env:
          SERVER_ALIAS: ${{ env.SERVER_ALIAS }}
          PASSWORD: ${{ env.PASSWORD }}
